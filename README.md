# rongcloud-node-im-sdk-lite
[![rongcloud-node-im-sdk-lite](http://img.shields.io/npm/v/rongcloud-node-im-sdk-lite.svg)](https://www.npmjs.org/package/rongcloud-node-im-sdk-lite)

> [rongcloud-web-im-sdk-v2](https://github.com/rongcloud/rongcloud-web-im-sdk-v2) çš„ node éƒ¨åˆ†ç§»æ¤ç‰ˆã€‚

## why
ä¸ºä»€ä¹ˆè¦æœ‰è¿™ä¸ªåŒ…ï¼Ÿå› ä¸ºæœ‰æ—¶å€™å®ƒèƒ½ä¸ºä½ çœä¸‹å¥½å¤šæœºå™¨ï¼Œå¥½å¤šè½¯å¦¹å¸ã€‚  
å†åˆ™ï¼Œé¡ºé“èƒ½å­¦ä¹ ä¸‹ Bufferï¼ŒTypedArrayï¼ŒWebSocket è¿˜æ˜¯ä¸é”™çš„ï¼Œè›®èƒ½å¼€é˜”è§†é‡çš„ã€‚

## protobuf è§£æ
`.proto` ä½ç½®åœ¨ `config/rongcloud.proto`ï¼Œé…åˆ [protobufjs](https://github.com/dcodeIO/protobuf.js) è§£æåº“ï¼Œå¯¹èäº‘æ¶ˆæ¯ä½“è¿›è¡Œè§£æï¼Œè¯¦æƒ…æŸ¥çœ‹ `lib/protobuf.js`ã€‚

## äº¤äº’æµç¨‹
```
                                                                                     
    <---------------------------------Server-------------------------------------->  
      ^         |        ^   |                   ^   |          ^         |          
      |         |        |   |                   |   |          |         |          
      |         |    connect |                   |   |          |         |          
      |         |       ws   |                   |   |        Send        |          
    Req      return   server |            Send   |   |   QueryConMessage  |          
   nav.js  WebSocket     |   |        QueryMessage   |          |         |          
      |     address   +--+   +--+          +-----+   +------+   |         +--+       
      |         |     |      return        |        return  |   |          Send      
      |         |     |  ConnAckMessage    |    QueryAckMessage |     PublishMessage 
      |         |     |         |          |                |   |            |       
      |         |     |         |          |                |   |            |       
      |         |     |         |          |                |   |            |       
      |         v     |         v          |                v   |            v       
    <---------------------------------Client-------------------------------------->  
                                                                                     
                                                                                     
                                                                                     
                                                                                     
     <-----------------------------Server------------------------------------------> 
       ^                 ^            |                                              
       |                 |            |             +----------------------+         
       |                 |            |             |                      |         
   Response            Send           |             |       /\_/\          |         
PublishMessage    PingReqMessage      |             |     =( Â°wÂ° )=        |         
     With            Interval      Return           |       )   (  //      |         
 PubAckMessage           |     PingRespMessage      |      (__ __)//       |         
       |                 |            |             |                      |         
       |                 |            |             |                      |         
       |                 |            |             +----------------------+         
       |                 |            v                                              
     <---------------------------------Client--------------------------------------> 
                                                                                     
```


## æ¶ˆæ¯ç±»å‹
ç±»å‹è½¬æ¢å…¬å¼
```
(æ ‡è¯†ç¬¦å· >> 4) & 15
```

### ConnAckMessage
> WebSocket è¿æ¥è®¤è¯é€šè¿‡ server è¿”å›

```
  +---> ç±»å‹æ ‡è¯†ç¬¦
[ |
  |          é•¿åº¦
  |          |   |   |   ç”¨æˆ·èŠå¤©ID
  32, 0,  0, 0,  5,  98,  53,  52,
  
      |
  48, 50, 0, 22, 97, 122, 112, 97,
  .... åé¢ä½æš‚æ—¶æœªç”¨åˆ° .....
]
```
å–å‡ºçš„ç”¨æˆ·IDï¼Œåœ¨ QueryMessage é‡Œä½œä¸ºè¾“å…¥

### QueryMessage 
> client è¯·æ±‚å†å²æ¶ˆæ¯æŠ¥æ–‡å¦‚ä¸‹

```
  +---> ç±»å‹æ ‡è¯†ç¬¦
  |
  |     é•¿åº¦
  |    |    |   p    u    l    l   M
[ |    |    |   |    |    |    |   |
  82,  0,   7, 112, 117, 108, 108, 77, 
  
                    |    ç”¨æˆ·ID
  s     g   é•¿åº¦    b    1    0    8
  |     |   |  |    |    |    |    |
  115, 103, 0, 6,   98,  49,  48,  56,
  
       |
  0    6
  |    |
  48,  54,  0, 1,   8,   0,   16,  0, 
  32,  1
]
```
éœ€è¦å˜åŠ¨çš„æ˜¯ç”¨æˆ·IDä»¥åŠå‰æ–¹é•¿åº¦éƒ¨åˆ†ï¼Œæ¯”å¦‚ç”¨æˆ·ä¸º c1782ï¼Œåˆ™å¯¹åº” Ascii ç ä¸º `0, 5, 99, 49, 55, 56, 50`

### QueryAckMessage
> QueryMessage è¯·æ±‚çš„ Server åº”ç­”

```
  +---> ç±»å‹æ ‡è¯†ç¬¦
  |
[ |         |  unixï¼ˆç§’ï¼‰  |
  99, 0, 1, 86, 236, 255, 212, 0,
  0,  10, .............protobuf..
  ..æ¶ˆæ¯ä½“.......................
]
```
æ­¤å¤„çš„ protobuf æ¶ˆæ¯ä½“ï¼Œéœ€è¦ç”¨ `Modules['DownStreamMessage'].decode` æ–¹æ³•è§£æã€‚  
æ­¤å¤„çš„æ—¶é—´è½¬æ¢ä¹Ÿå¾ˆæœ‰æ„æ€
```
                      è½¬æ¢ä¸º16è¿›åˆ¶ï¼Œé•¿åº¦ä¸º2ï¼Œç¼ºä½å‰æ–¹è¡¥ 0
[86, 236, 255, 212] =======================================> ["56", "ec", "ff", "d4"]
parseInt("56ecffd4", 16) =====> 1458372564 
```
### QueryConMessage
> client æ”¶åˆ° QueryAckMessage åå‘æœåŠ¡å™¨åšå‡ºçš„åº”ç­”

```
  +---> ç±»å‹æ ‡è¯†ç¬¦
  |       + æœ¬æ¬¡ä¼šè¯å†…ï¼Œç¬¬å‡ æ¬¡å‘é€æ­¤ç±»å‹æ¶ˆæ¯
[ |       |
  112, 0, 1
]
```

### PublishMessage
> server å‘ client é€’é€èŠå¤©æ¶ˆæ¯ï¼Œæ¶ˆæ¯ä¸ºå…¶ä»–ç”¨æˆ·å‘ç»™æ­¤ client ç™»å½•çš„ç”¨æˆ·ï¼Œtopic ä¸º s_msgï¼Œ

```
  +---> ç±»å‹æ ‡è¯†ç¬¦
  |
  |
[ |    |    unixï¼ˆç§’ï¼‰ |            |
  51,  86,  238, 6,   212, 0,  5,  115, 
  
    Topic         |            |
  95,  109, 115, 103, 0,   8,  99, 49, 
  
    æ¶ˆæ¯æ¥è‡ªè°             |
  55,  50,  48,  53,  56,  50, 0,  1,
  ........protobuf æ¶ˆæ¯ä½“............
]
```
æ­¤å¤„çš„ protobuf æ¶ˆæ¯ä½“ï¼Œéœ€è¦ç”¨ `Modules['DownStreamMessage'].decode` æ–¹æ³•æ¥è§£æï¼Œæ³¨æ„ DownStreamMessage æ˜¯å•æ•°

> server å‘ client é€’é€èŠå¤©æ¶ˆæ¯ï¼Œæ¶ˆæ¯ä¸ºæ­¤ client ç™»å½•çš„ç”¨æˆ·ï¼Œåœ¨å…¶ä»–ç«¯å‘é€çš„æ¶ˆæ¯ï¼Œtopic ä¸º ppMsgPã€‚

```
[                       |
  58,  0,  0,   0,   0,  0, 6, 112, 
  
    Topic            |
  112, 77, 115, 103, 80, ...
  ...åŒ 51 ç±»å‹...
]
```
æ­¤å¤„çš„ protobuf æ¶ˆæ¯ä½“ï¼Œéœ€è¦ç”¨ `Modules.UpStreamMessage.decode` æ–¹æ³•æ¥è§£æ

### PubAckMessage 
> æ”¶åˆ° PublishMessage å client çš„åº”ç­”.

```
         + æœ¬æ¬¡ä¼šè¯å†…ï¼Œç¬¬å‡ æ¬¡å‘é€æ­¤ç±»å‹æ¶ˆæ¯
[        |
  64, 0, 1
];
```

### PingReqMessage
> client å‘é€ç»™æœåŠ¡å™¨çš„ ğŸ’“ å¿ƒè·³åŒ…

```
[
  -64
];
```
æ­¤å¤„ä½¿ç”¨ Typedarray çš„æ—¶å€™ï¼Œè®°å¾—é€‰æ‹© Int8Arrayï¼Œå¸¦ç¬¦å·ä½æ•°ç»„ã€‚

### PingRespMessage
> æœåŠ¡å™¨  ğŸ’“  å¿ƒè·³åŒ…è¿”å›

```
[
  -64
]
```

## Tips
ä½¿ç”¨ QueryMessage çš„æ—¶å€™ï¼Œæ³¨æ„èäº‘æ¶ˆæ¯24ç‚¹è¿‡æœŸæœºåˆ¶
